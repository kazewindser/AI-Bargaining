{% extends 'global/Page.html' %}
{% block title %}Stage {{ stage }} {% endblock %}


{% block content %}

<h3>ç¬¬ {{ player.round_number }} ãƒ©ã‚¦ãƒ³ãƒ‰ - ã‚¹ãƒ†ãƒ¼ã‚¸ {{ stage }}</h3>

<p>ã‚ãªãŸã®å½¹å‰²ï¼š<b>{{ you }}</b></p>

<hr>

<p><b>{{ other }}</b> ãŒã‚ãªãŸã«ã€100ãƒã‚¤ãƒ³ãƒˆä¸­ <b>{{ offer }}</b> ãƒã‚¤ãƒ³ãƒˆã‚’æ‰‹æ¸¡ã™ã“ã¨ã‚’ææ¡ˆã—ã¾ã—ãŸã€‚</p>

<p>ç¾åœ¨ã®æ®µéšã§ã®ã‚ãªãŸã®å‰²å¼•ç‡ï¼š<b>{{ my_discount  }}</b></p>

<hr>

<p><strong style="color: red;">å¿…ãšé¸æŠã—ã¦ãã ã•ã„ :</strong></p>


{% formfield player.accepted_offer %}

<!-- ğŸ”´ å®æ—¶é¢„è§ˆåŒºåŸŸ -->
<div id="preview" style="background-color: #f8f9fa; padding: 15px; margin: 20px 0; border-left: 4px solid #28a745; border-radius: 5px; display: none;">
    <h4 style="margin-top: 0; color: #28a745;">ğŸ“Š å—ã‘å…¥ã‚ŒãŸå ´åˆã®çµæœ / Result if Accepted</h4>
    <table style="width: 100%; border-collapse: collapse;">
        <tr style="border-bottom: 2px solid #dee2e6;">
            <th style="padding: 8px; text-align: left;">å½¹å‰² / Role</th>
            <th style="padding: 8px; text-align: right;">ææ¡ˆã—ãŸãƒã‚¤ãƒ³ãƒˆ / Original Points</th>
            <th style="padding: 8px; text-align: right;">å‰²å¼•ç‡ / Discount Rate</th>
            <th style="padding: 8px; text-align: right;">å‰²å¼•å¾Œã®ãƒã‚¤ãƒ³ãƒˆ / Discounted Points</th>
        </tr>
        <tr style="background-color: #e7f3ff;">
            <td style="padding: 8px;"><b>ã‚ãªãŸ ({{ you }})</b></td>
            <td style="padding: 8px; text-align: right;"><span id="you-original">-</span></td>
            <td style="padding: 8px; text-align: right;"><span id="you-discount">-</span></td>
            <td style="padding: 8px; text-align: right;"><strong><span id="you-discounted">-</span></strong></td>
        </tr>
        <tr style="background-color: #fff3cd;">
            <td style="padding: 8px;"><b>{{ other }}</b></td>
            <td style="padding: 8px; text-align: right;"><span id="other-original">-</span></td>
            <td style="padding: 8px; text-align: right;"><span id="other-discount">-</span></td>
            <td style="padding: 8px; text-align: right;"><strong><span id="other-discounted">-</span></strong></td>
        </tr>
    </table>
    <p style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">
        â€» ã“ã®è¡¨ã¯ã€Œå—ã‘å…¥ã‚Œã‚‹ã€ã‚’é¸æŠã—ãŸå ´åˆã®çµæœã‚’ç¤ºã—ã¦ã„ã¾ã™
    </p>
</div>

{% next_button %}

<script>
    // ä»æ¨¡æ¿ä¼ é€’çš„å¸¸é‡
    const ENDOWMENT = parseInt("{{ endowment }}");
    const STAGE = parseInt("{{ stage }}");
    const YOU_ROLE = "{{ you }}";
    const OTHER_ROLE = "{{ other }}";
    const OFFER_POINTS = parseInt("{{ offer }}");

    // æŠ˜æ‰£ç‡ï¼ˆæ ¹æ®è§’è‰²å’Œé˜¶æ®µè®¡ç®—ï¼‰
    const DISCOUNT_P1 = 0.6;
    const DISCOUNT_P2 = 0.4;

    function getDiscountRate(stage, role) {
        if (stage === 1) {
            return 1.0;
        } else if (stage === 2) {
            return role === "P1" ? DISCOUNT_P1 : DISCOUNT_P2;
        } else { // stage === 3
            return role === "P1" ? Math.pow(DISCOUNT_P1, 2) : Math.pow(DISCOUNT_P2, 2);
        }
    }

    function updatePreview() {
        const radioButtons = document.querySelectorAll('input[name="accepted_offer"]');
        let acceptSelected = false;

        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†"æ¥å—"
        radioButtons.forEach(radio => {
            if (radio.checked && radio.value === 'True') {
                acceptSelected = true;
            }
        });

        // å¦‚æœé€‰æ‹©äº†"æ¥å—"ï¼Œæ˜¾ç¤ºé¢„è§ˆ
        if (acceptSelected) {
            // å“åº”è€…æ”¶åˆ°çš„ç‚¹æ•°
            const youOriginal = OFFER_POINTS;
            const otherOriginal = ENDOWMENT - OFFER_POINTS;

            // è·å–æŠ˜æ‰£ç‡
            const youDiscount = getDiscountRate(STAGE, YOU_ROLE);
            const otherDiscount = getDiscountRate(STAGE, OTHER_ROLE);

            // è®¡ç®—æŠ˜æ‰£åç‚¹æ•°
            const youDiscounted = youOriginal * youDiscount;
            const otherDiscounted = otherOriginal * otherDiscount;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('you-original').textContent = youOriginal;
            document.getElementById('you-discount').textContent = youDiscount.toFixed(2);
            document.getElementById('you-discounted').textContent = youDiscounted.toFixed(2);

            document.getElementById('other-original').textContent = otherOriginal;
            document.getElementById('other-discount').textContent = otherDiscount.toFixed(2);
            document.getElementById('other-discounted').textContent = otherDiscounted.toFixed(2);

            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            document.getElementById('preview').style.display = 'block';
        } else {
            // å¦‚æœé€‰æ‹©äº†"æ‹’ç»"æˆ–æœªé€‰æ‹©ï¼Œéšè—é¢„è§ˆ
            document.getElementById('preview').style.display = 'none';
        }
    }

    // ç›‘å¬å•é€‰æŒ‰é’®å˜åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        const radioButtons = document.querySelectorAll('input[name="accepted_offer"]');
        radioButtons.forEach(radio => {
            radio.addEventListener('change', updatePreview);
        });

        // å¦‚æœå·²æœ‰é€‰æ‹©ï¼Œç«‹å³æ›´æ–°
        updatePreview();
    });
</script>

{% endblock %}