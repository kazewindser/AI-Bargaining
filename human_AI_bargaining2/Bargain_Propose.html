{% extends 'global/Page.html' %}
{% block title %}Stage {{ stage }} {% endblock %}

{% block content %}

<h3>ç¬¬ {{ player.round_number }} ãƒ©ã‚¦ãƒ³ãƒ‰ - ã‚¹ãƒ†ãƒ¼ã‚¸ {{ stage }}</h3>

<p>ã‚ãªãŸã®å½¹å‰²ï¼š<b>{{ you }}</b></p>

<hr>

<p>ã“ã®æ®µéšã§ã®ã‚ãªãŸã®å‰²å¼•ç‡ï¼š<b>{{ my_discount }}</b></p>

<p>100ãƒã‚¤ãƒ³ãƒˆä¸­ã€<b>{{ other }}</b>ï¼ˆAI)ã«æ‰‹æ¸¡ã™ãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼š</p>

{% formfield player.offer_points label="æ‰‹æ¸¡ã™ãƒã‚¤ãƒ³ãƒˆï¼ˆ0-100ï¼‰" %}

<!-- ğŸ”´ å®æ—¶é¢„è§ˆåŒºåŸŸ -->
<div id="preview" style="background-color: #f8f9fa; padding: 15px; margin: 20px 0; border-left: 4px solid #28a745; border-radius: 5px; display: none;">
    <h4 style="margin-top: 0; color: #28a745;">ğŸ“Š ææ¡ˆçµæœã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ / Offer Preview</h4>
    <table style="width: 100%; border-collapse: collapse;">
        <tr style="border-bottom: 2px solid #dee2e6;">
            <th style="padding: 8px; text-align: left;">å½¹å‰² / Role</th>
            <th style="padding: 8px; text-align: right;">ææ¡ˆã—ãŸãƒã‚¤ãƒ³ãƒˆ / Original Points</th>
            <th style="padding: 8px; text-align: right;">å‰²å¼•ç‡ / Discount Rate</th>
            <th style="padding: 8px; text-align: right;">å‰²å¼•å¾Œã®ãƒã‚¤ãƒ³ãƒˆ / Discounted Points</th>
        </tr>
        <tr style="background-color: #e7f3ff;">
            <td style="padding: 8px;"><b>ã‚ãªãŸ ({{ you }})</b></td>
            <td style="padding: 8px; text-align: right;"><span id="you-original">-</span></td>
            <td style="padding: 8px; text-align: right;"><span id="you-discount">-</span></td>
            <td style="padding: 8px; text-align: right;"><strong><span id="you-discounted">-</span></strong></td>
        </tr>
        <tr style="background-color: #fff3cd;">
            <td style="padding: 8px;"><b>{{ other }} (AI)</b></td>
            <td style="padding: 8px; text-align: right;"><span id="other-original">-</span></td>
            <td style="padding: 8px; text-align: right;"><span id="other-discount">-</span></td>
            <td style="padding: 8px; text-align: right;"><strong><span id="other-discounted">-</span></strong></td>
        </tr>
    </table>
</div>

{% next_button %}

<script>
    // ä»æ¨¡æ¿ä¼ é€’çš„å¸¸é‡
    const ENDOWMENT = parseInt("{{ endowment }}");
    const STAGE = parseInt("{{ stage }}");
    const YOU_ROLE = "{{ you }}";
    const OTHER_ROLE = "{{ other }}";
    
    // æŠ˜æ‰£ç‡ï¼ˆæ ¹æ®è§’è‰²å’Œé˜¶æ®µè®¡ç®—ï¼‰
    const DISCOUNT_P1 = 0.6;
    const DISCOUNT_P2 = 0.4;
    
    function getDiscountRate(stage, role) {
        if (stage === 1) {
            return 1.0;
        } else if (stage === 2) {
            return role === "P1" ? DISCOUNT_P1 : DISCOUNT_P2;
        } else { // stage === 3
            return role === "P1" ? Math.pow(DISCOUNT_P1, 2) : Math.pow(DISCOUNT_P2, 2);
        }
    }
    
    function updatePreview() {
        const input = document.querySelector('input[name="offer_points"]');
        const offerPoints = parseInt(input.value) || 0;
        
        // éªŒè¯è¾“å…¥èŒƒå›´
        if (offerPoints < 0 || offerPoints > ENDOWMENT || input.value === '') {
            document.getElementById('preview').style.display = 'none';
            return;
        }
        
        // è®¡ç®—åŸå§‹ç‚¹æ•°
        const youOriginal = ENDOWMENT - offerPoints;
        const otherOriginal = offerPoints;
        
        // è·å–æŠ˜æ‰£ç‡
        const youDiscount = getDiscountRate(STAGE, YOU_ROLE);
        const otherDiscount = getDiscountRate(STAGE, OTHER_ROLE);
        
        // è®¡ç®—æŠ˜æ‰£åç‚¹æ•°
        const youDiscounted = youOriginal * youDiscount;
        const otherDiscounted = otherOriginal * otherDiscount;
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('you-original').textContent = youOriginal;
        document.getElementById('you-discount').textContent = youDiscount.toFixed(2);
        document.getElementById('you-discounted').textContent = youDiscounted.toFixed(2);
        
        document.getElementById('other-original').textContent = otherOriginal;
        document.getElementById('other-discount').textContent = otherDiscount.toFixed(2);
        document.getElementById('other-discounted').textContent = otherDiscounted.toFixed(2);
        
        // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
        document.getElementById('preview').style.display = 'block';
    }


    // ç›‘å¬è¾“å…¥å˜åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.querySelector('input[name="offer_points"]');
        if (input) {
            input.addEventListener('input', updatePreview);
            input.addEventListener('change', updatePreview);
            // å¦‚æœå·²æœ‰å€¼ï¼Œç«‹å³æ›´æ–°
            if (input.value) {
                updatePreview();
            }
        }
    });
</script>

{% endblock %}